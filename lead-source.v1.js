;(()=>{const CFG=window.__LS_CONFIG||{};const DEBUG=!!CFG.debug;const MIN_FIELDS=Number.isFinite(CFG.minFields)?CFG.minFields:3;const EXTRA_MSG_KEYS=Array.isArray(CFG.extraMessageKeys)?CFG.extraMessageKeys.map(s=>String(s).toLowerCase()):[];const INCLUDE_CAMPAIGN=CFG.includeCampaign!==false;const INCLUDE_ADID=CFG.includeAdId!==false;const FT_KEY='ls_ft_v2';const LP_KEY='ls_lp_v2';const log=(...args)=>{if(DEBUG)console.log('[LS]',...args)};const nowISO=()=>new Date().toISOString();function safeSet(k,v,useSession=false){try{(useSession?sessionStorage:localStorage).setItem(k,JSON.stringify(v))}catch(e){log('storage set fail',k,e)}}function safeGet(k,useSession=false){try{const s=(useSession?sessionStorage:localStorage).getItem(k);return s?JSON.parse(s):null}catch(e){return null}}function parseQS(url){try{const u=new URL(url||location.href);return Object.fromEntries(u.searchParams.entries())}catch(e){return{}}}function host(u){try{return new URL(u).hostname||''}catch(e){return''}}function hostPath(u){try{const x=new URL(u);return(x.host+x.pathname).replace(/\/+$/,'/')}catch(e){return''}}const RE_SE=/google\.|bing\.|baidu\.|yahoo\.|duckduckgo\.|yandex\.|so\.com|sogou\.|sm\.cn/i;const RE_SO=/facebook\.|instagram\.|twitter\.|t\.co|x\.com|linkedin\.|youtube\.|tiktok\.|weibo\.|wechat\.|reddit\./i;const RE_PAID_SRC=/adwords|gads|pmax|facebook|meta|ttads|tiktok|bing|microsoft|quora|reddit/i;const RE_PAID_MED=/(cpc|ppc|paid|cpa|cpv|cpm|pmax)/i;function detectFirstTouch(){const r=document.referrer||'';const rh=host(r);const q=parseQS(location.href);const paid=!!(q.gclid||q.gbraid||q.wbraid||RE_PAID_MED.test(q.utm_medium||'')||RE_PAID_SRC.test(q.utm_source||''));let channel='直接访问',source='(direct)',medium='none';if(paid){channel='付费投放';source=q.utm_source||'adwords';medium=q.utm_medium||'ppc'}else if(r&&RE_SE.test(rh)){channel='自然搜索';source=rh.replace(/^www\./,'');medium='organic'}else if(r&&RE_SO.test(rh)){channel='社交';source=rh.replace(/^www\./,'');medium='social'}else if(r&&rh&&rh!==location.hostname){channel='外部推荐';source=rh.replace(/^www\./,'');medium='referral'}else if(r&&rh===location.hostname){channel='站内跳转';source=location.hostname;medium='internal'}return{ts:nowISO(),channel,source,medium,campaign:q.utm_campaign||'',gclid:q.gclid||q.gbraid||q.wbraid||'',referrer:r,landing_page:location.href}}function ensureTouch(){if(!safeGet(FT_KEY)){const ft=detectFirstTouch();safeSet(FT_KEY,ft);log('first-touch set',ft)}if(!safeGet(LP_KEY,true)){const lp={ts:nowISO(),url:location.href,referrer:document.referrer||''};safeSet(LP_KEY,lp,true);log('session-landing set',lp)}}function fieldElems(form){return Array.from(form.querySelectorAll('input,select,textarea')).filter(el=>{if(el.disabled)return false;const t=(el.type||'').toLowerCase();return!['hidden','submit','button','image','file','reset'].includes(t)})}const RE_SEARCH_KEYS=/^(q|s|search|keyword|kw|query)$/i;const RE_AUTH=/password|passwd|login|otp|2fa|auth/i;const RE_EMAIL=/email|e-mail/i;const RE_PHONE=/phone|tel|mobile|whatsapp|wa/i;const RE_NAME=/name|fullname|contact|your-name/i;const RE_MSG=/message|content|inquiry|enquiry|comments?|detail|description|note|notes|your-(inquiry|message)/i;function isSearchForm(form){if((form.getAttribute('role')||'').toLowerCase()==='search')return true;if(form.querySelector('input[type="search"]'))return true;const act=(form.getAttribute('action')||'').toLowerCase();if(/search|[?&](q|s)=/.test(act))return true;const f=fieldElems(form);if(f.length<=2){const names=f.map(el=>(el.name||el.id||'').toLowerCase());if(names.some(x=>RE_SEARCH_KEYS.test(x)))return true}return false}function isAuthForm(form){const names=fieldElems(form).map(el=>(el.name||el.id||'').toLowerCase());return names.some(x=>RE_AUTH.test(x))}function isNewsletter(form){const f=fieldElems(form);if(f.length<=2){const n=f.map(el=>(el.name||el.id||'').toLowerCase());if(n.some(x=>RE_EMAIL.test(x))&&!n.some(x=>RE_MSG.test(x)))return true}return false}function hasMessageField(form){if(form.querySelector('textarea[name], textarea[id]')){const found=Array.from(form.querySelectorAll('textarea, input[type="text"]')).some(el=>{const key=(el.name||el.id||'').toLowerCase();return RE_MSG.test(key)||EXTRA_MSG_KEYS.includes(key)});if(found)return true}if(form.querySelector('textarea'))return true;return false}function isInquiryForm(form){if(isSearchForm(form)||isAuthForm(form)||isNewsletter(form))return false;const f=fieldElems(form);if(f.length<MIN_FIELDS)return false;if(hasMessageField(form))return true;const names=f.map(el=>(el.name||el.id||'').toLowerCase());let score=0;if(names.some(x=>RE_EMAIL.test(x)))score++;if(names.some(x=>RE_PHONE.test(x)))score++;if(names.some(x=>RE_NAME.test(x)))score++;return score>=2}const MESSAGE_KEYS=['form_fields[message]','form_fields[content]','form_fields[inquiry]','form_fields[enquiry]','your-inquiry','your-message','your-enquiry','your-content','message','content','inquiry','enquiry','comments','comment','detail','description','note','notes','msg'].concat(EXTRA_MSG_KEYS);function pickMessageField(form){let el=form.querySelector(MESSAGE_KEYS.map(k=>`[name="${CSS.escape(k)}"]`).join(','));if(!el)el=Array.from(form.querySelectorAll('textarea,input[type="text"]')).find(e=>{const key=(e.name||e.id||'').toLowerCase();return MESSAGE_KEYS.some(k=>key===k.toLowerCase())||RE_MSG.test(key)});if(!el)el=Array.from(form.querySelectorAll('textarea,input[type="text"]')).find(e=>{const ph=(e.getAttribute('placeholder')||'').toLowerCase();return/message|inquiry|enquiry|content|备注|留言|询盘/.test(ph)});if(!el)el=form.querySelector('textarea');return el||null}function summaryLines(){const ft=safeGet(FT_KEY)||{};const lp=safeGet(LP_KEY,true)||{};const lines=[];if(ft.channel){if(ft.source&&ft.medium&&ft.medium!=='none'){lines.push(`来源：${ft.channel}（${ft.source}/${ft.medium}）`)}else if(ft.source){lines.push(`来源：${ft.channel}（${ft.source}）`)}else{lines.push(`来源：${ft.channel}`)}}else{lines.push('来源：未知')}if(INCLUDE_CAMPAIGN&&ft.campaign)lines.push(`活动：${ft.campaign}`);if(INCLUDE_ADID&&ft.gclid)lines.push(`广告ID：${ft.gclid}`);if(lp.url)lines.push(`首落地页：${hostPath(lp.url)}`);lines.push(`提交页面：${location.host}${location.pathname}`);return lines}function alreadyTagged(text){return/\n?来源：/.test(text)}function attachForm(form){if(form.__ls_bound__)return;form.__ls_bound__=true;form.addEventListener('submit',(ev)=>{if(!isInquiryForm(form))return;const msgEl=pickMessageField(form);if(!msgEl){log('no message field');return}const orig=(msgEl.value||'');const lines=summaryLines();const block=lines.join('\n');if(alreadyTagged(orig))return;let glue=orig?'\n\n':'';msgEl.value=orig+glue+block;log('message patched',msgEl.name||msgEl.id||msgEl.tagName);Promise.resolve().then(()=>{});setTimeout(()=>{try{msgEl.value=orig}catch(e){}},600);const restoreOnce=()=>{try{msgEl.value=orig}catch(e){}form.removeEventListener('wpcf7mailsent',restoreOnce);form.removeEventListener('wpcf7invalid',restoreOnce);document.removeEventListener('elementor-pro/forms/unload',restoreOnce)};form.addEventListener('wpcf7mailsent',restoreOnce);form.addEventListener('wpcf7invalid',restoreOnce);document.addEventListener('elementor-pro/forms/unload',restoreOnce)},true)}function scanAll(){Array.from(document.forms||[]).forEach(attachForm)}const mo=new MutationObserver(muts=>{for(const m of muts){for(const node of m.addedNodes||[]){if(node.nodeType!==1)continue;if(node.tagName==='FORM')attachForm(node);const forms=node.querySelectorAll?node.querySelectorAll('form'):[];forms&&forms.forEach(attachForm)}}});function start(){try{ensureTouch()}catch(e){log('ensureTouch error',e)}try{scanAll()}catch(e){log('scan error',e)}try{mo.observe(document.documentElement,{childList:true,subtree:true})}catch(e){}log('ready')}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',start)}else{start()}})();